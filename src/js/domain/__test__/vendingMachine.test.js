/* eslint-disable max-lines-per-function */
import VendingMachineProduct from '../VendingMachineProduct';
import VendingMachine from '../VendingMachine';
import { ERROR_MESSAGE, VENDING_MACHINE_RULES } from '../../constants';

describe('자판기 클래스 테스트', () => {
  let vendingMachine;
  let initialProduct;
  let productId;

  beforeEach(() => {
    vendingMachine = new VendingMachine();
    initialProduct = { name: '콜라', price: 2500, stock: 20 };
    productId = vendingMachine.addProduct(initialProduct);
  });

  describe('상품 추가 기능 테스트', () => {
    test('상품의 이름, 가격, 수량을 입력하면 새로운 상품을 상품목록에 추가한다.', () => {
      const mockVendingMachineProduct = new VendingMachineProduct(initialProduct);

      expect(vendingMachine.productList[productId]).toEqual(mockVendingMachineProduct);
    });

    test('동일한 이름의 상품을 추가하는 경우 오류가 발생한다.', () => {
      const invalidProduct = { name: '콜라', price: 2000, stock: 10 };

      expect(() => vendingMachine.addProduct(invalidProduct)).toThrow(
        ERROR_MESSAGE.DUPLICATE_PRODUCT_NAME
      );
    });
  });

  describe('상품 수정 기능 테스트', () => {
    test('상품의 이름을 수정할 수 있다.', () => {
      const newProductData = { name: '코카콜라', price: 2500, stock: 20 };
      vendingMachine.updateProduct(productId, newProductData);

      expect(vendingMachine.productList[productId].name).toBe('코카콜라');
    });

    test('상품의 가격을 수정할 수 있다.', () => {
      const newProductData = { name: '콜라', price: 1800, stock: 20 };
      vendingMachine.updateProduct(productId, newProductData);

      expect(vendingMachine.productList[productId].price).toBe(1800);
    });

    test('상품의 재고를 수정할 수 있다.', () => {
      const newProductData = { name: '콜라', price: 2500, stock: 10 };
      vendingMachine.updateProduct(productId, newProductData);

      expect(vendingMachine.productList[productId].stock).toBe(10);
    });

    test('상품의 복수 정보를 수정할 수 있다.', () => {
      const newProductData = { name: '사이다', price: 2500, stock: 10 };
      vendingMachine.updateProduct(productId, newProductData);

      expect(vendingMachine.productList[productId]).toEqual(
        new VendingMachineProduct(newProductData)
      );
    });

    test('상품목록에 없는 상품을 수정할 경우 오류가 발생한다.', () => {
      const newProductData = { name: '사이다', price: 2500, stock: 10 };
      const invalidId = 'invalidId';

      expect(() => vendingMachine.updateProduct(invalidId, newProductData)).toThrow(
        ERROR_MESSAGE.NOT_FOUND_PRODUCT_ID
      );
    });
  });

  describe('상품 삭제 기능 테스트', () => {
    test('특정 상품을 삭제할 수 있다.', () => {
      vendingMachine.removeProduct(productId);

      expect(vendingMachine.productList[productId]).toBeUndefined();
    });

    test('상품목록에 없는 상품을 삭제할 경우 오류가 발생한다.', () => {
      const invalidId = 'invalidId';

      expect(() => vendingMachine.removeProduct(invalidId)).toThrow(
        ERROR_MESSAGE.NOT_FOUND_PRODUCT_ID
      );
    });
  });

  describe('잔돈 충전 테스트', () => {
    test('잔돈을 충전할 수 있다.', () => {
      const inputMoney = 5000;

      vendingMachine.addChange(inputMoney);

      expect(vendingMachine.totalChange).toBe(inputMoney);
    });

    test('충전 금액이 0원 이하면 오류가 발생한다.', () => {
      const inputMoney = 0;

      expect(() => vendingMachine.addChange(inputMoney)).toThrow(
        ERROR_MESSAGE.BELOW_MIN_CHANGE
      );
    });

    test(`충전 금액이 ${VENDING_MACHINE_RULES.CHANGE_UNIT}원 단위가 아니면 오류가 발생한다.`, () => {
      const inputMoney = 1025;

      expect(() => vendingMachine.addChange(inputMoney)).toThrow(
        ERROR_MESSAGE.INVALID_UNIT_CHANGE
      );
    });

    test(`충전 금액이  ${VENDING_MACHINE_RULES.MAX_TOTAL_CHANGE}원을 초과하면 오류가 발생한다.`, () => {
      const inputMoney = 100010;

      expect(() => vendingMachine.addChange(inputMoney)).toThrow(
        ERROR_MESSAGE.EXCEED_MAX_TOTAL_CHANGE
      );
    });

    test(`충전 금액과 보유 금액의 합이 ${VENDING_MACHINE_RULES.MAX_TOTAL_CHANGE}원을 초과하면 오류가 발생한다.`, () => {
      const firstInputMoney = 50000;
      vendingMachine.addChange(firstInputMoney);

      const secondInputMoney = 50010;
      expect(() => vendingMachine.addChange(secondInputMoney)).toThrow(
        ERROR_MESSAGE.EXCEED_MAX_TOTAL_CHANGE
      );
    });
  });

  describe('금액 투입 기능 테스트', () => {
    test('금액 투입을 입력하면 자판기에 해당 금액이 저장된다.', () => {
      const money = 3000;
      vendingMachine.insertMoney(money);
      expect(vendingMachine.totalMoney).toBe(money);
    });

    test('금액은 누적으로 투입할 수 있다.', () => {
      const initialInputMoney = 3000;
      const secondInputMoney = 4500;
      vendingMachine.insertMoney(initialInputMoney);
      vendingMachine.insertMoney(secondInputMoney);
      expect(vendingMachine.totalMoney).toBe(initialInputMoney + secondInputMoney);
    });

    test('10원 단위로 떨어지지 않는 금액을 투입하면 에러가 발생한다.', () => {
      const invalidMoney = 1211;
      expect(() => vendingMachine.insertMoney(invalidMoney)).toThrow();
    });

    test('투입 금액이 10,000원을 초과하면 에러가 발생한다.', () => {
      const invalidMoney = 10010;
      expect(() => vendingMachine.insertMoney(invalidMoney)).toThrow();
    });
  });

  describe('상품구매 테스트', () => {
    test('넣은 돈이하의 가격을 가진 상품을 구매할 수 있다.', () => {
      vendingMachine.insertMoney(3000);
      const { stock } = vendingMachine.productList[productId];
      vendingMachine.sellProduct(productId);
      expect(vendingMachine.productList[productId].stock).toBe(stock - 1);
    });

    test('넣은 돈이상의 가격을 가진 상품을 구매할 수 없다.', () => {
      vendingMachine.insertMoney(2400);

      expect(() => vendingMachine.sellProduct(productId)).toThrow();
    });

    test('재고가 없는 상품을 구매하면 에러가 발생한다.', () => {
      const product = { name: '사이다', price: 2500, stock: 1 };
      productId = vendingMachine.addProduct(product);
      vendingMachine.insertMoney(5000);
      vendingMachine.sellProduct(productId);
      expect(() => vendingMachine.sellProduct(productId)).toThrow();
    });
  });
});
